{"version":3,"sources":["../../test/remote_reporter.js"],"names":["_lodash","require","_lodash2","_interopRequireDefault","_chai","_const_sampler","_const_sampler2","_in_memory_reporter","_in_memory_reporter2","_mock_logger","_mock_logger2","_remote_reporter","_remote_reporter2","_tracer","_tracer2","_udp_sender","_udp_sender2","_metrics","_metrics2","_metric_factory","_metric_factory2","_backend","_backend2","obj","__esModule","default","describe","tracer","reporter","sender","logger","metrics","beforeEach","e","console","log","stack","afterEach","clear","callback","close","it","span","startSpan","finish","assert","equal","_batch","spans","length","flush","isOk","counterEquals","reporterSuccess","_maxSpanBytes","_errorMsgs","reporterDropped","setProcess","serviceName","tags","name","expect","to","throw","mockSender","err","numSpans","_sender","reporterFailure"],"mappings":"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","file":"remote_reporter.js","sourcesContent":["'use strict';\n\nvar _lodash = require('lodash');\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nvar _chai = require('chai');\n\nvar _const_sampler = require('../src/samplers/const_sampler');\n\nvar _const_sampler2 = _interopRequireDefault(_const_sampler);\n\nvar _in_memory_reporter = require('../src/reporters/in_memory_reporter');\n\nvar _in_memory_reporter2 = _interopRequireDefault(_in_memory_reporter);\n\nvar _mock_logger = require('./lib/mock_logger');\n\nvar _mock_logger2 = _interopRequireDefault(_mock_logger);\n\nvar _remote_reporter = require('../src/reporters/remote_reporter');\n\nvar _remote_reporter2 = _interopRequireDefault(_remote_reporter);\n\nvar _tracer = require('../src/tracer');\n\nvar _tracer2 = _interopRequireDefault(_tracer);\n\nvar _udp_sender = require('../src/reporters/udp_sender');\n\nvar _udp_sender2 = _interopRequireDefault(_udp_sender);\n\nvar _metrics = require('../src/metrics/metrics');\n\nvar _metrics2 = _interopRequireDefault(_metrics);\n\nvar _metric_factory = require('./lib/metrics/local/metric_factory');\n\nvar _metric_factory2 = _interopRequireDefault(_metric_factory);\n\nvar _backend = require('./lib/metrics/local/backend');\n\nvar _backend2 = _interopRequireDefault(_backend);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\ndescribe('Composite and Remote Reporter should', function () {\n    var tracer = void 0;\n    var reporter = void 0;\n    var sender = void 0;\n    var logger = void 0;\n    var metrics = void 0;\n\n    beforeEach(function () {\n        try {\n            metrics = new _metrics2.default(new _metric_factory2.default());\n            sender = new _udp_sender2.default();\n            logger = new _mock_logger2.default();\n            reporter = new _remote_reporter2.default(sender, {\n                logger: logger,\n                metrics: metrics\n            });\n            tracer = new _tracer2.default('test-service-name', reporter, new _const_sampler2.default(true));\n        } catch (e) {\n            // this is useful to catch errors when thrift definition is changed\n            console.log('beforeEach failed', e);\n            console.log(e.stack);\n        }\n    });\n\n    afterEach(function () {\n        logger.clear();\n        var callback = function callback() {}; // added for coverage reasons\n        reporter.close(callback);\n    });\n\n    it('report span, and flush', function () {\n        var span = tracer.startSpan('operation-name');\n\n        // add duration to span, and report it\n        span.finish();\n        _chai.assert.equal(sender._batch.spans.length, 1);\n\n        reporter.flush();\n        _chai.assert.equal(sender._batch.spans.length, 0);\n        _chai.assert.isOk(_backend2.default.counterEquals(metrics.reporterSuccess, 1));\n    });\n\n    it('report and flush span that is causes an error to be logged', function () {\n        // make it so that all spans will be too large to be appended\n        sender._maxSpanBytes = 1;\n\n        var span = tracer.startSpan('operation-name');\n\n        span.finish();\n        _chai.assert.equal(logger._errorMsgs[0], 'Failed to append spans in reporter.');\n\n        // metrics\n        _chai.assert.isOk(_backend2.default.counterEquals(metrics.reporterDropped, 1));\n    });\n\n    it('should have coverage for simple code paths', function () {\n        var sender = new _udp_sender2.default();\n        sender.setProcess({\n            serviceName: 'service-name',\n            tags: []\n        });\n        var reporter = new _remote_reporter2.default(sender);\n\n        _chai.assert.equal(reporter.name(), 'RemoteReporter');\n\n        reporter.close();\n    });\n\n    it('should throw exception when initialized without a sender', function () {\n        (0, _chai.expect)(function () {\n            new _remote_reporter2.default();\n        }).to.throw('RemoteReporter must be given a Sender.');\n    });\n\n    it('failed to flush spans with reporter', function () {\n        var mockSender = {\n            flush: function flush() {\n                return {\n                    err: true,\n                    numSpans: 1\n                };\n            },\n            close: function close() {}\n        };\n\n        reporter._sender = mockSender;\n        reporter.flush();\n\n        _chai.assert.equal(logger._errorMsgs[0], 'Failed to flush spans in reporter.');\n        _chai.assert.isOk(_backend2.default.counterEquals(metrics.reporterFailure, 1));\n    });\n}); // Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n//# sourceMappingURL=remote_reporter.js.map"]}