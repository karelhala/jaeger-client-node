{"version":3,"sources":["../../test/rate_limiter.js"],"names":["_chai","require","_rate_limiter","_rate_limiter2","_interopRequireDefault","_sinon","_sinon2","obj","__esModule","default","describe","it","initialDate","Date","getTime","clock","useFakeTimers","limiter","i","assert","equal","checkCredit","restore","_i","limit","cost"],"mappings":"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","file":"rate_limiter.js","sourcesContent":["'use strict';\n\nvar _chai = require('chai');\n\nvar _rate_limiter = require('../src/rate_limiter');\n\nvar _rate_limiter2 = _interopRequireDefault(_rate_limiter);\n\nvar _sinon = require('sinon');\n\nvar _sinon2 = _interopRequireDefault(_sinon);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\ndescribe('leaky bucket ratelimiter should', function () {\n    it('block after threshold is met', function () {\n        var initialDate = new Date(2011, 9, 1).getTime();\n        var clock = _sinon2.default.useFakeTimers(initialDate);\n        var limiter = new _rate_limiter2.default(10, 10);\n        for (var i = 0; i < 10; i++) {\n            _chai.assert.equal(limiter.checkCredit(1), true, 'expected checkCredit to be true');\n        }\n        _chai.assert.equal(limiter.checkCredit(1), false, 'expected checkCredit to be false');\n\n        clock.restore();\n        clock = _sinon2.default.useFakeTimers(initialDate + 1000);\n        for (var _i = 0; _i < 10; _i++) {\n            _chai.assert.equal(limiter.checkCredit(1), true, 'expected checkCredit to be true');\n        }\n        _chai.assert.equal(limiter.checkCredit(1), false, 'expected checkCredit to be false');\n        clock.restore();\n    });\n\n    it('work for fractional values', function () {\n        var initialDate = new Date(2011, 9, 1).getTime();\n        var clock = _sinon2.default.useFakeTimers(initialDate);\n        var limit = 500;\n        var cost = 1 / limit;\n        var limiter = new _rate_limiter2.default(1, 1);\n        for (var i = 0; i < limit; i++) {\n            limiter.checkCredit(cost);\n        }\n\n        _chai.assert.equal(limiter.checkCredit(cost), false, 'expected checkCredit to be false');\n\n        clock.restore();\n        clock = _sinon2.default.useFakeTimers(initialDate + 1000);\n        _chai.assert.equal(limiter.checkCredit(cost), true, 'expected checkCredit to be true');\n        clock.restore();\n    });\n\n    it('work with creditsPerSecond smaller than 1', function () {\n        var initialDate = new Date(2011, 9, 1).getTime();\n        var clock = _sinon2.default.useFakeTimers(initialDate);\n        var limiter = new _rate_limiter2.default(0.1, 1);\n        _chai.assert.equal(limiter.checkCredit(1), true, 'expected checkCredit to be true');\n\n        clock.restore();\n        // move time 20s forward, enough to accumulate credits for 2 messages, but it should still be capped at 1\n        clock = _sinon2.default.useFakeTimers(initialDate + 20000);\n        _chai.assert.equal(limiter.checkCredit(1), true, 'expected checkCredit to be true');\n        _chai.assert.equal(limiter.checkCredit(1), false, 'expected checkCredit to be false');\n        clock.restore();\n    });\n}); // Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n//# sourceMappingURL=rate_limiter.js.map"]}