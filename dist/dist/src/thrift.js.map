{"version":3,"sources":["../../src/thrift.js"],"names":["Object","defineProperty","exports","value","_typeof","Symbol","iterator","obj","constructor","prototype","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","key","Constructor","protoProps","staticProps","_fs","require","_fs2","_interopRequireDefault","_opentracing","_opentracing2","_path","_path2","_thriftrw","_util","_util2","__esModule","default","_classCallCheck","instance","TypeError","ThriftUtils","getThriftTags","initialTags","thriftTags","tag","vLong","emptyBuffer","vBinary","vBool","vDouble","vStr","vType","valueType","_thrift","TagType","DOUBLE","BOOL","Buffer","BINARY","STRING","JSON","stringify","String","push","getThriftLogs","logs","thriftLogs","log","encodeInt64","timestamp","fields","spanRefsToThriftRefs","refs","thriftRefs","refEnum","ref","context","referencedContext","type","REFERENCE_CHILD_OF","SpanRefType","CHILD_OF","REFERENCE_FOLLOWS_FROM","FOLLOWS_FROM","refType","traceIdLow","traceId","traceIdHigh","spanId","spanToThrift","span","tags","_tags","_logs","unsigned","_spanContext","parentSpanId","parentId","operationName","_operationName","references","_references","flags","startTime","_startTime","duration","_duration","Thrift","source","readFileSync","join","__dirname","allowOptionalArguments"],"mappings":"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","file":"thrift.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nvar _fs = require('fs');\n\nvar _fs2 = _interopRequireDefault(_fs);\n\nvar _opentracing = require('opentracing');\n\nvar _opentracing2 = _interopRequireDefault(_opentracing);\n\nvar _path = require('path');\n\nvar _path2 = _interopRequireDefault(_path);\n\nvar _thriftrw = require('thriftrw');\n\nvar _util = require('./util.js');\n\nvar _util2 = _interopRequireDefault(_util);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar ThriftUtils = function () {\n    function ThriftUtils() {\n        _classCallCheck(this, ThriftUtils);\n    }\n\n    _createClass(ThriftUtils, null, [{\n        key: 'getThriftTags',\n        value: function getThriftTags(initialTags) {\n            var thriftTags = [];\n            for (var i = 0; i < initialTags.length; i++) {\n                var tag = initialTags[i];\n\n                var key = tag.key;\n\n                var vLong = ThriftUtils.emptyBuffer;\n                var vBinary = ThriftUtils.emptyBuffer;\n                var vBool = false;\n                var vDouble = 0;\n                var vStr = '';\n\n                var vType = '';\n                var valueType = _typeof(tag.value);\n                if (valueType === 'number') {\n                    vType = ThriftUtils._thrift.TagType.DOUBLE;\n                    vDouble = tag.value;\n                } else if (valueType === 'boolean') {\n                    vType = ThriftUtils._thrift.TagType.BOOL;\n                    vBool = tag.value;\n                } else if (tag.value instanceof Buffer) {\n                    vType = ThriftUtils._thrift.TagType.BINARY;\n                    vBinary = tag.value;\n                } else if (valueType === 'object') {\n                    vType = ThriftUtils._thrift.TagType.STRING;\n                    vStr = JSON.stringify(tag.value);\n                } else {\n                    vType = ThriftUtils._thrift.TagType.STRING;\n                    if (valueType === 'string') {\n                        vStr = tag.value;\n                    } else {\n                        vStr = String(tag.value);\n                    }\n                }\n\n                thriftTags.push({\n                    key: key,\n                    vType: vType,\n                    vStr: vStr,\n                    vDouble: vDouble,\n                    vBool: vBool,\n                    vLong: vLong,\n                    vBinary: vBinary\n                });\n            }\n\n            return thriftTags;\n        }\n    }, {\n        key: 'getThriftLogs',\n        value: function getThriftLogs(logs) {\n            var thriftLogs = [];\n            for (var i = 0; i < logs.length; i++) {\n                var log = logs[i];\n                thriftLogs.push({\n                    'timestamp': _util2.default.encodeInt64(log.timestamp * 1000), // to microseconds\n                    'fields': ThriftUtils.getThriftTags(log.fields)\n                });\n            }\n\n            return thriftLogs;\n        }\n    }, {\n        key: 'spanRefsToThriftRefs',\n        value: function spanRefsToThriftRefs(refs) {\n            var thriftRefs = [];\n            for (var i = 0; i < refs.length; i++) {\n                var refEnum = void 0;\n                var ref = refs[i];\n                var context = refs[i].referencedContext();\n\n                if (ref.type() === _opentracing2.default.REFERENCE_CHILD_OF) {\n                    refEnum = ThriftUtils._thrift.SpanRefType.CHILD_OF;\n                } else if (ref.type() === _opentracing2.default.REFERENCE_FOLLOWS_FROM) {\n                    refEnum = ThriftUtils._thrift.SpanRefType.FOLLOWS_FROM;\n                } else {\n                    continue;\n                }\n\n                thriftRefs.push({\n                    refType: refEnum,\n                    traceIdLow: context.traceId,\n                    traceIdHigh: ThriftUtils.emptyBuffer,\n                    spanId: context.spanId\n                });\n            }\n\n            return thriftRefs;\n        }\n    }, {\n        key: 'spanToThrift',\n        value: function spanToThrift(span) {\n            var tags = ThriftUtils.getThriftTags(span._tags);\n            var logs = ThriftUtils.getThriftLogs(span._logs);\n            var unsigned = true;\n\n            return {\n                traceIdLow: span._spanContext.traceId,\n                traceIdHigh: ThriftUtils.emptyBuffer, // TODO(oibe) implement 128 bit ids\n                spanId: span._spanContext.spanId,\n                parentSpanId: span._spanContext.parentId || ThriftUtils.emptyBuffer,\n                operationName: span._operationName,\n                references: ThriftUtils.spanRefsToThriftRefs(span._references),\n                flags: span._spanContext.flags,\n                startTime: _util2.default.encodeInt64(span._startTime * 1000), // to microseconds\n                duration: _util2.default.encodeInt64(span._duration * 1000), // to microseconds\n                tags: tags,\n                logs: logs\n            };\n        }\n    }]);\n\n    return ThriftUtils;\n}();\n\nThriftUtils._thrift = new _thriftrw.Thrift({\n    source: _fs2.default.readFileSync(_path2.default.join(__dirname, './jaeger-idl/thrift/jaeger.thrift'), 'ascii'),\n    allowOptionalArguments: true\n});\nThriftUtils.emptyBuffer = new Buffer([0, 0, 0, 0, 0, 0, 0, 0]);\nexports.default = ThriftUtils;\n//# sourceMappingURL=thrift.js.map"]}