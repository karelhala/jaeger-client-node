{"version":3,"sources":["../../../src/samplers/guaranteed_throughput_sampler.js"],"names":["Object","defineProperty","exports","value","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","key","Constructor","protoProps","staticProps","prototype","_constants","require","constants","_interopRequireWildcard","_probabilistic_sampler","_probabilistic_sampler2","_interopRequireDefault","_ratelimiting_sampler","_ratelimiting_sampler2","obj","__esModule","default","newObj","hasOwnProperty","call","_classCallCheck","instance","TypeError","GuaranteedThroughputSampler","lowerBound","samplingRate","_probabilisticSampler","_lowerBoundSampler","_tagsPlaceholder","name","toString","maxTracesPerSecond","isSampled","operation","tags","decision","SAMPLER_TYPE_TAG_KEY","SAMPLER_TYPE_LOWER_BOUND","SAMPLER_PARAM_TAG_KEY","equal","other","close","callback","update","updated"],"mappings":"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","file":"guaranteed_throughput_sampler.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nvar _constants = require('../constants.js');\n\nvar constants = _interopRequireWildcard(_constants);\n\nvar _probabilistic_sampler = require('./probabilistic_sampler.js');\n\nvar _probabilistic_sampler2 = _interopRequireDefault(_probabilistic_sampler);\n\nvar _ratelimiting_sampler = require('./ratelimiting_sampler.js');\n\nvar _ratelimiting_sampler2 = _interopRequireDefault(_ratelimiting_sampler);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n// GuaranteedThroughputProbabilisticSampler is a sampler that leverages both probabilisticSampler and\n// rateLimitingSampler. The rateLimitingSampler is used as a guaranteed lower bound sampler such that\n// every operation is sampled at least once in a time interval defined by the lowerBound. ie a lowerBound\n// of 1.0 / (60 * 10) will sample an operation at least once every 10 minutes.\n//\n// The probabilisticSampler is given higher priority when tags are emitted, ie. if IsSampled() for both\n// samplers return true, the tags for probabilisticSampler will be used.\nvar GuaranteedThroughputSampler = function () {\n    function GuaranteedThroughputSampler(lowerBound, samplingRate) {\n        _classCallCheck(this, GuaranteedThroughputSampler);\n\n        this._probabilisticSampler = new _probabilistic_sampler2.default(samplingRate);\n        this._lowerBoundSampler = new _ratelimiting_sampler2.default(lowerBound);\n        // we never let the lowerBoundSampler return its real tags, so avoid allocations\n        // by reusing the same placeholder object\n        this._tagsPlaceholder = {};\n    }\n\n    _createClass(GuaranteedThroughputSampler, [{\n        key: 'name',\n        value: function name() {\n            return 'GuaranteedThroughputSampler';\n        }\n    }, {\n        key: 'toString',\n        value: function toString() {\n            return this.name() + '(samplingRate=' + this._probabilisticSampler.samplingRate + ', lowerBound=' + this._lowerBoundSampler.maxTracesPerSecond + ')';\n        }\n    }, {\n        key: 'isSampled',\n        value: function isSampled(operation, tags) {\n            if (this._probabilisticSampler.isSampled(operation, tags)) {\n                // make rate limiting sampler update its budget\n                this._lowerBoundSampler.isSampled(operation, this._tagsPlaceholder);\n                return true;\n            }\n            var decision = this._lowerBoundSampler.isSampled(operation, this._tagsPlaceholder);\n            if (decision) {\n                tags[constants.SAMPLER_TYPE_TAG_KEY] = constants.SAMPLER_TYPE_LOWER_BOUND;\n                tags[constants.SAMPLER_PARAM_TAG_KEY] = this._probabilisticSampler.samplingRate;\n            }\n            return decision;\n        }\n    }, {\n        key: 'equal',\n        value: function equal(other) {\n            if (!(other instanceof GuaranteedThroughputSampler)) {\n                return false;\n            }\n            return this._probabilisticSampler.equal(other._probabilisticSampler) && this._lowerBoundSampler.equal(other._lowerBoundSampler);\n        }\n    }, {\n        key: 'close',\n        value: function close(callback) {\n            // neither probabilistic nor rate limiting samplers allocate resources,\n            // so their close methods are effectively no-op. We do not need to\n            // pass the callback to them (if we did we'd need to wrap it).\n            this._probabilisticSampler.close(function () {});\n            this._lowerBoundSampler.close(function () {});\n            if (callback) {\n                callback();\n            }\n        }\n    }, {\n        key: 'update',\n        value: function update(lowerBound, samplingRate) {\n            var updated = false;\n            if (this._probabilisticSampler.samplingRate != samplingRate) {\n                this._probabilisticSampler = new _probabilistic_sampler2.default(samplingRate);\n                updated = true;\n            }\n            if (this._lowerBoundSampler.maxTracesPerSecond != lowerBound) {\n                this._lowerBoundSampler = new _ratelimiting_sampler2.default(lowerBound);\n                updated = true;\n            }\n            return updated;\n        }\n    }]);\n\n    return GuaranteedThroughputSampler;\n}();\n\nexports.default = GuaranteedThroughputSampler;\n//# sourceMappingURL=guaranteed_throughput_sampler.js.map"]}