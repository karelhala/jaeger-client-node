{"version":3,"sources":["../../../crossdock/test/tchannel_server.js"],"names":["_lodash","require","_lodash2","_interopRequireDefault","_chai","_constants","constants","_interopRequireWildcard","_constants2","crossdock_constants","_const_sampler","_const_sampler2","_default_context","_default_context2","_opentracing","_opentracing2","_in_memory_reporter","_in_memory_reporter2","_tchannel_bridge","_tchannel_bridge2","_tchannel_server","_tchannel_server2","_thrift","_thrift2","_tchannel","_tchannel2","_tracer","_tracer2","_fs","_fs2","_path","_path2","_util","_util2","obj","__esModule","newObj","key","Object","prototype","hasOwnProperty","call","default","process","env","NODE_ENV","describe","ip","server","tracer","bridge","crossdockSpecPath","join","__dirname","before","myIp","it","done","span","startSpan","setBaggageItem","BAGGAGE_KEY","clientChannel","requestChannel","makeSubChannel","serviceName","peers","thriftChannel","channel","entryPoint","tracedChannel","joinRequest","context","setSpan","request","timeout","headers","cn","send","err","res","assert","isNotOk","traceResponse","body","equal","traceId","traceIdStr","downstream","sampled","baggage","getBaggageItem"],"mappings":"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","file":"tchannel_server.js","sourcesContent":["'use strict';\n\nvar _lodash = require('lodash');\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nvar _chai = require('chai');\n\nvar _constants = require('../../src/constants');\n\nvar constants = _interopRequireWildcard(_constants);\n\nvar _constants2 = require('../src/constants');\n\nvar crossdock_constants = _interopRequireWildcard(_constants2);\n\nvar _const_sampler = require('../../src/samplers/const_sampler.js');\n\nvar _const_sampler2 = _interopRequireDefault(_const_sampler);\n\nvar _default_context = require('../../src/default_context');\n\nvar _default_context2 = _interopRequireDefault(_default_context);\n\nvar _opentracing = require('opentracing');\n\nvar _opentracing2 = _interopRequireDefault(_opentracing);\n\nvar _in_memory_reporter = require('../../src/reporters/in_memory_reporter.js');\n\nvar _in_memory_reporter2 = _interopRequireDefault(_in_memory_reporter);\n\nvar _tchannel_bridge = require('../../src/tchannel_bridge');\n\nvar _tchannel_bridge2 = _interopRequireDefault(_tchannel_bridge);\n\nvar _tchannel_server = require('../src/tchannel_server.js');\n\nvar _tchannel_server2 = _interopRequireDefault(_tchannel_server);\n\nvar _thrift = require('tchannel/as/thrift');\n\nvar _thrift2 = _interopRequireDefault(_thrift);\n\nvar _tchannel = require('tchannel');\n\nvar _tchannel2 = _interopRequireDefault(_tchannel);\n\nvar _tracer = require('../../src/tracer.js');\n\nvar _tracer2 = _interopRequireDefault(_tracer);\n\nvar _fs = require('fs');\n\nvar _fs2 = _interopRequireDefault(_fs);\n\nvar _path = require('path');\n\nvar _path2 = _interopRequireDefault(_path);\n\nvar _util = require('../../src/util.js');\n\nvar _util2 = _interopRequireDefault(_util);\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nprocess.env.NODE_ENV = 'test';\n\n// WARNING THESE TESTS DO NOT WORK WHEN THE VPN IS RUNNING.\n\ndescribe('crossdock tchannel server should', function () {\n    var ip = void 0;\n    var server = void 0;\n    var tracer = void 0;\n    var bridge = void 0;\n    var crossdockSpecPath = _path2.default.join(__dirname, '..', '..', 'src', 'jaeger-idl', 'thrift', 'crossdock', 'tracetest.thrift');\n\n    before(function () {\n        tracer = new _tracer2.default('node', new _in_memory_reporter2.default(), new _const_sampler2.default(false));\n        bridge = new _tchannel_bridge2.default(tracer);\n        server = new _tchannel_server2.default(crossdockSpecPath);\n        ip = _util2.default.myIp();\n    });\n\n    describe('joinTrace with different options', function () {\n\n        it('propagate span state on tchannel joinTrace', function (done) {\n            var span = tracer.startSpan('test-span');\n            span.setBaggageItem(crossdock_constants.BAGGAGE_KEY, 'fry');\n\n            var clientChannel = new _tchannel2.default();\n\n            var requestChannel = clientChannel.makeSubChannel({\n                serviceName: 'node',\n                peers: [_util2.default.myIp() + ':8082']\n            });\n            var thriftChannel = (0, _thrift2.default)({\n                channel: requestChannel,\n                entryPoint: crossdockSpecPath\n            });\n            var tracedChannel = bridge.tracedChannel(thriftChannel);\n\n            var joinRequest = {\n                'serverRole': 'S1',\n                'downstream': {\n                    'serviceName': 'node',\n                    'serverRole': 'S2',\n                    'host': _util2.default.myIp(),\n                    'port': '8082',\n                    'transport': 'TCHANNEL'\n                }\n            };\n\n            var context = new _default_context2.default();\n            context.setSpan(span);\n            tracedChannel.request({\n                timeout: 100000,\n                context: context,\n                serviceName: 'node',\n                headers: {\n                    cn: 'node-tchannel'\n                }\n            }).send('TracedService::joinTrace', null, { 'request': joinRequest }, function (err, res) {\n                if (err) {\n                    _chai.assert.isNotOk(err);\n                } else {\n                    var traceResponse = res.body;\n                    _chai.assert.equal(traceResponse.span.traceId, span.context().traceIdStr);\n                    _chai.assert.equal(traceResponse.span.traceId, traceResponse.downstream.span.traceId);\n                    _chai.assert.equal(traceResponse.span.sampled, false);\n                    _chai.assert.equal(traceResponse.span.baggage, span.getBaggageItem(crossdock_constants.BAGGAGE_KEY));\n                }\n                done();\n            });\n        }).timeout(100000);\n    });\n});\n//# sourceMappingURL=tchannel_server.js.map"]}