{"version":3,"sources":["../../../crossdock/test/http_server.js"],"names":["_chai","require","_http_server","_http_server2","_interopRequireDefault","_request","_request2","obj","__esModule","default","process","env","NODE_ENV","describe","server","before","it","done","sampled","baggage","host","startRequest","setTimeout","headers","post","JSON","stringify","err","response","console","log","assert","isNotOk","traceResponse","parse","body","isOk","span","traceId","equal","downstream","notImplementedError","timeout","joinRequest"],"mappings":"AAAA;;AAEA,IAAIA,QAAQC,QAAQ,MAAR,CAAZ;;AAEA,IAAIC,eAAeD,QAAQ,uBAAR,CAAnB;;AAEA,IAAIE,gBAAgBC,uBAAuBF,YAAvB,CAApB;;AAEA,IAAIG,WAAWJ,QAAQ,SAAR,CAAf;;AAEA,IAAIK,YAAYF,uBAAuBC,QAAvB,CAAhB;;AAEA,SAASD,sBAAT,CAAgCG,GAAhC,EAAqC;AAAE,WAAOA,OAAOA,IAAIC,UAAX,GAAwBD,GAAxB,GAA8B,EAAEE,SAASF,GAAX,EAArC;AAAwD;;AAE/FG,QAAQC,GAAR,CAAYC,QAAZ,GAAuB,MAAvB,C,CAA+B;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAC,SAAS,8BAAT,EAAyC,YAAY;AACjD,QAAIC,SAAS,KAAK,CAAlB;AACAC,WAAO,YAAY;AACfD,iBAAS,IAAIX,cAAcM,OAAlB,EAAT;AACH,KAFD;;AAIAO,OAAG,yEAAH,EAA8E,UAAUC,IAAV,EAAgB;AAC1F,YAAIC,UAAU,IAAd;AACA,YAAIC,UAAU,kBAAd;AACA,YAAIC,OAAO,WAAX;AACA,YAAIC,eAAe;AACf,0BAAc,IADC;AAEf,uBAAWH,OAFI;AAGf,uBAAWC,OAHI;AAIf,0BAAc;AACV,+BAAe,MADL;AAEV,8BAAc,IAFJ;AAGV,wBAAQC,IAHE;AAIV,wBAAQ,MAJE;AAKV,6BAAa,MALH;AAMV,8BAAc;AACV,mCAAe,MADL;AAEV,kCAAc,IAFJ;AAGV,4BAAQA,IAHE;AAIV,4BAAQ,MAJE;AAKV,iCAAa;AALH;AANJ;AAJC,SAAnB;;AAoBAE,mBAAW,YAAY;AACnB,gBAAIC,UAAU,EAAE,gBAAgB,kBAAlB,EAAd;AACAjB,sBAAUG,OAAV,CAAkBe,IAAlB,CAAuB;AACnB,uBAAO,mCADY;AAEnB,2BAAW,IAFQ;AAGnB,2BAAWD,OAHQ;AAInB,wBAAQE,KAAKC,SAAL,CAAeL,YAAf;AAJW,aAAvB,EAKG,UAAUM,GAAV,EAAeC,QAAf,EAAyB;AACxB,oBAAID,GAAJ,EAAS;AACLE,4BAAQC,GAAR,CAAY,KAAZ,EAAmBH,GAAnB;AACH;;AAED;AACA3B,sBAAM+B,MAAN,CAAaC,OAAb,CAAqBL,GAArB;AACA,oBAAIM,gBAAgBR,KAAKS,KAAL,CAAWN,SAASO,IAApB,CAApB;AACAnC,sBAAM+B,MAAN,CAAaK,IAAb,CAAkBH,cAAcI,IAAd,CAAmBC,OAArC;AACAtC,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcI,IAAd,CAAmBnB,OAAtC,EAA+C,IAA/C;AACAlB,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcI,IAAd,CAAmBlB,OAAtC,EAA+C,kBAA/C;;AAEA;AACAnB,sBAAM+B,MAAN,CAAaK,IAAb,CAAkBH,cAAcO,UAAhC;AACAxC,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcQ,mBAAjC,EAAsD,EAAtD;AACAzC,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcI,IAAd,CAAmBC,OAAtC,EAA+CL,cAAcO,UAAd,CAAyBH,IAAzB,CAA8BC,OAA7E;AACAtC,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcO,UAAd,CAAyBH,IAAzB,CAA8BnB,OAAjD,EAA0D,IAA1D;AACAlB,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcO,UAAd,CAAyBH,IAAzB,CAA8BlB,OAAjD,EAA0D,kBAA1D;AACAnB,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcO,UAAd,CAAyBC,mBAA5C,EAAiE,EAAjE;;AAEA;AACAzC,sBAAM+B,MAAN,CAAaK,IAAb,CAAkBH,cAAcO,UAAd,CAAyBA,UAA3C;AACAxC,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcO,UAAd,CAAyBH,IAAzB,CAA8BC,OAAjD,EAA0DL,cAAcO,UAAd,CAAyBA,UAAzB,CAAoCH,IAApC,CAAyCC,OAAnG;AACAtC,sBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcO,UAAd,CAAyBA,UAAzB,CAAoCC,mBAAvD,EAA4E,EAA5E;AACAzC,sBAAM+B,MAAN,CAAaK,IAAb,CAAkBH,cAAcO,UAAd,CAAyBA,UAAzB,CAAoCH,IAApC,CAAyCnB,OAA3D,EAAoE,IAApE;AACAlB,sBAAM+B,MAAN,CAAaK,IAAb,CAAkBH,cAAcO,UAAd,CAAyBA,UAAzB,CAAoCH,IAApC,CAAyClB,OAA3D,EAAoE,kBAApE;AACAF;AACH,aAhCD;AAiCH,SAnCD,EAmCG,IAnCH;AAoCH,KA5DD,EA4DGyB,OA5DH,CA4DW,IA5DX;;AA8DA1B,OAAG,gDAAH,EAAqD,UAAUC,IAAV,EAAgB;AACjE,YAAIC,UAAU,IAAd;AACA,YAAIC,UAAU,kBAAd;AACA,YAAIC,OAAO,WAAX;AACA,YAAIC,eAAe;AACf,0BAAc,IADC;AAEf,uBAAWH,OAFI;AAGf,uBAAWC;AAHI,SAAnB;;AAMA,YAAII,UAAU,EAAE,gBAAgB,kBAAlB,EAAd;AACAjB,kBAAUG,OAAV,CAAkBe,IAAlB,CAAuB;AACnB,mBAAO,mCADY;AAEnB,uBAAW,IAFQ;AAGnB,uBAAWD,OAHQ;AAInB,oBAAQE,KAAKC,SAAL,CAAeL,YAAf;AAJW,SAAvB,EAKG,UAAUM,GAAV,EAAeC,QAAf,EAAyB;AACxB,gBAAID,GAAJ,EAAS;AACLE,wBAAQC,GAAR,CAAY,KAAZ,EAAmBH,GAAnB;AACH;AACD3B,kBAAM+B,MAAN,CAAaC,OAAb,CAAqBL,GAArB;AACA,gBAAIM,gBAAgBR,KAAKS,KAAL,CAAWN,SAASO,IAApB,CAApB;AACAnC,kBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcI,IAAd,CAAmBnB,OAAtC,EAA+C,IAA/C;AACAlB,kBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcI,IAAd,CAAmBlB,OAAtC,EAA+C,kBAA/C;AACAnB,kBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcQ,mBAAjC,EAAsD,EAAtD;AACAxB;AACH,SAfD;AAgBH,KA3BD;;AA6BAD,OAAG,+CAAH,EAAoD,UAAUC,IAAV,EAAgB;AAChE,YAAIC,UAAU,IAAd;AACA,YAAIC,UAAU,kBAAd;AACA,YAAIC,OAAO,WAAX;AACA,YAAIuB,cAAc;AACd,0BAAc;AADA,SAAlB;;AAIA,YAAIpB,UAAU,EAAE,gBAAgB,kBAAlB,EAAd;AACAjB,kBAAUG,OAAV,CAAkBe,IAAlB,CAAuB;AACnB,mBAAO,kCADY;AAEnB,uBAAW,IAFQ;AAGnB,uBAAWD,OAHQ;AAInB,oBAAQE,KAAKC,SAAL,CAAeiB,WAAf;AAJW,SAAvB,EAKG,UAAUhB,GAAV,EAAeC,QAAf,EAAyB;AACxB,gBAAID,GAAJ,EAAS;AACLE,wBAAQC,GAAR,CAAY,KAAZ,EAAmBH,GAAnB;AACH;;AAED3B,kBAAM+B,MAAN,CAAaC,OAAb,CAAqBL,GAArB;AACA,gBAAIM,gBAAgBR,KAAKS,KAAL,CAAWN,SAASO,IAApB,CAApB;AACAnC,kBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcI,IAAd,CAAmBnB,OAAtC,EAA+C,KAA/C;AACAlB,kBAAM+B,MAAN,CAAaQ,KAAb,CAAmBN,cAAcQ,mBAAjC,EAAsD,EAAtD;AACAxB;AACH,SAfD;AAgBH,KAzBD;AA0BH,CA3HD;AA4HA","file":"http_server.js","sourcesContent":["'use strict';\n\nvar _chai = require('chai');\n\nvar _http_server = require('../src/http_server.js');\n\nvar _http_server2 = _interopRequireDefault(_http_server);\n\nvar _request = require('request');\n\nvar _request2 = _interopRequireDefault(_request);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nprocess.env.NODE_ENV = 'test'; // Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\ndescribe('crossdock http server should', function () {\n    var server = void 0;\n    before(function () {\n        server = new _http_server2.default();\n    });\n\n    it('return proper trace response for start_request, and join_trace combined', function (done) {\n        var sampled = true;\n        var baggage = \"7e859ffef96e5da6\";\n        var host = \"127.0.0.1\";\n        var startRequest = {\n            \"serverRole\": \"S1\",\n            \"sampled\": sampled,\n            \"baggage\": baggage,\n            \"downstream\": {\n                \"serviceName\": \"node\",\n                \"serverRole\": \"S2\",\n                \"host\": host,\n                \"port\": \"8081\",\n                \"transport\": \"HTTP\",\n                \"downstream\": {\n                    \"serviceName\": \"node\",\n                    \"serverRole\": \"S3\",\n                    \"host\": host,\n                    \"port\": \"8081\",\n                    \"transport\": \"HTTP\"\n                }\n            }\n        };\n\n        setTimeout(function () {\n            var headers = { 'Content-Type': 'application/json' };\n            _request2.default.post({\n                'url': 'http://127.0.0.1:8081/start_trace',\n                'forever': true,\n                'headers': headers,\n                'body': JSON.stringify(startRequest)\n            }, function (err, response) {\n                if (err) {\n                    console.log('err', err);\n                }\n\n                // top level span\n                _chai.assert.isNotOk(err);\n                var traceResponse = JSON.parse(response.body);\n                _chai.assert.isOk(traceResponse.span.traceId);\n                _chai.assert.equal(traceResponse.span.sampled, true);\n                _chai.assert.equal(traceResponse.span.baggage, '7e859ffef96e5da6');\n\n                // downstream level 1\n                _chai.assert.isOk(traceResponse.downstream);\n                _chai.assert.equal(traceResponse.notImplementedError, '');\n                _chai.assert.equal(traceResponse.span.traceId, traceResponse.downstream.span.traceId);\n                _chai.assert.equal(traceResponse.downstream.span.sampled, true);\n                _chai.assert.equal(traceResponse.downstream.span.baggage, '7e859ffef96e5da6');\n                _chai.assert.equal(traceResponse.downstream.notImplementedError, '');\n\n                // downstream level 2\n                _chai.assert.isOk(traceResponse.downstream.downstream);\n                _chai.assert.equal(traceResponse.downstream.span.traceId, traceResponse.downstream.downstream.span.traceId);\n                _chai.assert.equal(traceResponse.downstream.downstream.notImplementedError, '');\n                _chai.assert.isOk(traceResponse.downstream.downstream.span.sampled, true);\n                _chai.assert.isOk(traceResponse.downstream.downstream.span.baggage, '7e859ffef96e5da6');\n                done();\n            });\n        }, 3000);\n    }).timeout(5000);\n\n    it('return proper trace response for start_request', function (done) {\n        var sampled = true;\n        var baggage = \"7e859ffef96e5da6\";\n        var host = \"127.0.0.1\";\n        var startRequest = {\n            \"serverRole\": \"S1\",\n            \"sampled\": sampled,\n            \"baggage\": baggage\n        };\n\n        var headers = { 'Content-Type': 'application/json' };\n        _request2.default.post({\n            'url': 'http://127.0.0.1:8081/start_trace',\n            'forever': true,\n            'headers': headers,\n            'body': JSON.stringify(startRequest)\n        }, function (err, response) {\n            if (err) {\n                console.log('err', err);\n            }\n            _chai.assert.isNotOk(err);\n            var traceResponse = JSON.parse(response.body);\n            _chai.assert.equal(traceResponse.span.sampled, true);\n            _chai.assert.equal(traceResponse.span.baggage, '7e859ffef96e5da6');\n            _chai.assert.equal(traceResponse.notImplementedError, '');\n            done();\n        });\n    });\n\n    it('return proper trace response for join_request', function (done) {\n        var sampled = true;\n        var baggage = \"7e859ffef96e5da6\";\n        var host = \"127.0.0.1\";\n        var joinRequest = {\n            \"serverRole\": \"S1\"\n        };\n\n        var headers = { 'Content-Type': 'application/json' };\n        _request2.default.post({\n            'url': 'http://127.0.0.1:8081/join_trace',\n            'forever': true,\n            'headers': headers,\n            'body': JSON.stringify(joinRequest)\n        }, function (err, response) {\n            if (err) {\n                console.log('err', err);\n            }\n\n            _chai.assert.isNotOk(err);\n            var traceResponse = JSON.parse(response.body);\n            _chai.assert.equal(traceResponse.span.sampled, false);\n            _chai.assert.equal(traceResponse.notImplementedError, '');\n            done();\n        });\n    });\n});\n//# sourceMappingURL=http_server.js.map"]}