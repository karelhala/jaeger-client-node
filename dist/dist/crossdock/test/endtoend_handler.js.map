{"version":3,"sources":["../../../crossdock/test/endtoend_handler.js"],"names":["_chai","require","_dgram","_dgram2","_interopRequireDefault","_fs","_fs2","_endtoend_handler","_endtoend_handler2","_path","_path2","_request","_request2","_test_util","_test_util2","_thriftrw","_bodyParser","_bodyParser2","_express","_express2","obj","__esModule","default","PORT","HOST","describe","server","thrift","beforeEach","createSocket","bind","Thrift","source","readFileSync","join","__dirname","allowOptionalArguments","handler","port","host","app","use","json","post","req","res","generateTraces","listen","afterEach","close","it","done","traceRequest","operation","count","tags","headers","JSON","stringify","err","response","thriftTagsToObject","span","value","forEach","tag","vType","vStr","vDouble","vBool","vLong","vBinary","push","key","on","address","msg","remote","thriftObj","Agent","emitBatch","argumentsMessageRW","readFrom","batch","body","assert","equal","spans","length","_tags","operationName","isOk","hasTags"],"mappings":"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","file":"endtoend_handler.js","sourcesContent":["'use strict';\n\nvar _chai = require('chai');\n\nvar _dgram = require('dgram');\n\nvar _dgram2 = _interopRequireDefault(_dgram);\n\nvar _fs = require('fs');\n\nvar _fs2 = _interopRequireDefault(_fs);\n\nvar _endtoend_handler = require('../src/endtoend_handler');\n\nvar _endtoend_handler2 = _interopRequireDefault(_endtoend_handler);\n\nvar _path = require('path');\n\nvar _path2 = _interopRequireDefault(_path);\n\nvar _request = require('request');\n\nvar _request2 = _interopRequireDefault(_request);\n\nvar _test_util = require('../../src/test_util');\n\nvar _test_util2 = _interopRequireDefault(_test_util);\n\nvar _thriftrw = require('thriftrw');\n\nvar _bodyParser = require('body-parser');\n\nvar _bodyParser2 = _interopRequireDefault(_bodyParser);\n\nvar _express = require('express');\n\nvar _express2 = _interopRequireDefault(_express);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n// Copyright (c) 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nvar PORT = 6832;\nvar HOST = '127.0.0.1';\n\ndescribe('Endtoend Handler should', function () {\n    var server = void 0;\n    var thrift = void 0;\n\n    beforeEach(function () {\n        server = _dgram2.default.createSocket('udp4');\n        server.bind(PORT, HOST);\n        thrift = new _thriftrw.Thrift({\n            source: _fs2.default.readFileSync(_path2.default.join(__dirname, '../../src/jaeger-idl/thrift/jaeger.thrift'), 'ascii'),\n            allowOptionalArguments: true\n        });\n\n        var handler = new _endtoend_handler2.default({ port: PORT, host: HOST });\n        var app = (0, _express2.default)();\n        app.use(_bodyParser2.default.json());\n        app.post('/create_traces', function (req, res) {\n            handler.generateTraces(req, res);\n        });\n\n        app.listen(8083, function () {});\n    });\n\n    afterEach(function () {\n        server.close();\n    });\n\n    it('report spans to local server', function (done) {\n        var traceRequest = {\n            operation: 'leela',\n            count: 5,\n            tags: { 'key': 'value' }\n        };\n\n        var headers = { 'Content-Type': 'application/json' };\n        _request2.default.post({\n            'url': 'http://127.0.0.1:8083/create_traces',\n            'forever': true,\n            'headers': headers,\n            'body': JSON.stringify(traceRequest)\n        }, function (err, response) {});\n\n        function thriftTagsToObject(span) {\n            var tags = [];\n            var value = void 0;\n            span.tags.forEach(function (tag) {\n                if (tag.vType === 'STRING') {\n                    value = tag.vStr;\n                } else if (tag.vType === 'DOUBLE') {\n                    value = tag.vDouble;\n                } else if (tag.vType === 'BOOL') {\n                    value = tag.vBool;\n                } else if (tag.vType === 'LONG') {\n                    value = tag.vLong;\n                } else {\n                    value = tag.vBinary;\n                }\n\n                tags.push({ key: tag.key, value: value });\n            });\n            return tags;\n        }\n        server.on('listening', function () {\n            var address = server.address();\n        });\n        server.on('message', function (msg, remote) {\n            var thriftObj = thrift.Agent.emitBatch.argumentsMessageRW.readFrom(msg, 0);\n            var batch = thriftObj.value.body.batch;\n\n            _chai.assert.equal(batch.spans.length, 5);\n\n            batch.spans.forEach(function (span) {\n                span._tags = thriftTagsToObject(span);\n                _chai.assert.equal(span.operationName, 'leela');\n                _chai.assert.isOk(_test_util2.default.hasTags(span, {\n                    'key': 'value'\n                }));\n            });\n            done();\n        });\n    });\n});\n//# sourceMappingURL=endtoend_handler.js.map"]}