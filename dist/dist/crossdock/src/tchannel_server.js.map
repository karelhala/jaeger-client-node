{"version":3,"sources":["../../../crossdock/src/tchannel_server.js"],"names":["Object","defineProperty","exports","value","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","key","Constructor","protoProps","staticProps","prototype","_constants","require","constants","_interopRequireWildcard","_const_sampler","_const_sampler2","_interopRequireDefault","_default_context","_default_context2","_helpers","_helpers2","_in_memory_reporter","_in_memory_reporter2","_tracer","_tracer2","_opentracing","_opentracing2","_path","_path2","_tchannel_bridge","_tchannel_bridge2","_tchannel","_tchannel2","_thrift","_thrift2","_util","_util2","obj","__esModule","default","newObj","hasOwnProperty","call","_classCallCheck","instance","TypeError","DEFAULT_THRIFT_PATH","TChannelServer","crossdockSpecPath","arguments","undefined","serverChannel","tchannelThrift","context","bridge","tracedHandler","handleTChannelRequest","bind","register","listen","myIp","log","perProcessOptions","req","head","body","callback","isStartRequest","traceRequest","request","serverRole","json2str","promise","handleRequest","getSpan","then","tchannelResp","main","module","tchannel"],"mappings":"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","file":"tchannel_server.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nvar _constants = require('./constants.js');\n\nvar constants = _interopRequireWildcard(_constants);\n\nvar _const_sampler = require('../../src/samplers/const_sampler.js');\n\nvar _const_sampler2 = _interopRequireDefault(_const_sampler);\n\nvar _default_context = require('../../src/default_context.js');\n\nvar _default_context2 = _interopRequireDefault(_default_context);\n\nvar _helpers = require('./helpers');\n\nvar _helpers2 = _interopRequireDefault(_helpers);\n\nvar _in_memory_reporter = require('../../src/reporters/in_memory_reporter.js');\n\nvar _in_memory_reporter2 = _interopRequireDefault(_in_memory_reporter);\n\nvar _tracer = require('../../src/tracer.js');\n\nvar _tracer2 = _interopRequireDefault(_tracer);\n\nvar _opentracing = require('opentracing');\n\nvar _opentracing2 = _interopRequireDefault(_opentracing);\n\nvar _path = require('path');\n\nvar _path2 = _interopRequireDefault(_path);\n\nvar _tchannel_bridge = require('../../src/tchannel_bridge');\n\nvar _tchannel_bridge2 = _interopRequireDefault(_tchannel_bridge);\n\nvar _tchannel = require('tchannel');\n\nvar _tchannel2 = _interopRequireDefault(_tchannel);\n\nvar _thrift = require('tchannel/as/thrift');\n\nvar _thrift2 = _interopRequireDefault(_thrift);\n\nvar _util = require('../../src/util.js');\n\nvar _util2 = _interopRequireDefault(_util);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar DEFAULT_THRIFT_PATH = '/crossdock/tracetest.thrift';\n\nvar TChannelServer = function () {\n    function TChannelServer() {\n        var crossdockSpecPath = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : DEFAULT_THRIFT_PATH;\n\n        _classCallCheck(this, TChannelServer);\n\n        this._tracer = new _tracer2.default('node', new _in_memory_reporter2.default(), new _const_sampler2.default(false));\n        this._helpers = new _helpers2.default(this._tracer);\n\n        var serverChannel = (0, _tchannel2.default)({ 'serviceName': 'node' });\n        var tchannelThrift = (0, _thrift2.default)({\n            'channel': serverChannel,\n            'entryPoint': crossdockSpecPath\n        });\n        var context = new _default_context2.default();\n\n        var bridge = new _tchannel_bridge2.default(this._tracer);\n        var tracedHandler = bridge.tracedHandler(this.handleTChannelRequest.bind(this));\n        tchannelThrift.register(serverChannel, 'TracedService::joinTrace', context, tracedHandler);\n\n        serverChannel.listen(8082, _util2.default.myIp(), function () {\n            _helpers2.default.log('TChannel server listening on port 8082...');\n        });\n    }\n\n    _createClass(TChannelServer, [{\n        key: 'handleTChannelRequest',\n        value: function handleTChannelRequest(perProcessOptions, req, head, body, callback) {\n            var isStartRequest = false;\n            var traceRequest = body.request;\n            var context = req.context;\n            _helpers2.default.log('TChannel', traceRequest.serverRole, 'received joinTrace request', _helpers2.default.json2str(traceRequest));\n\n            var promise = this._helpers.handleRequest(isStartRequest, traceRequest, context.getSpan());\n\n            promise.then(function (tchannelResp) {\n                callback(null, {\n                    'ok': true,\n                    'body': tchannelResp\n                });\n            });\n        }\n    }]);\n\n    return TChannelServer;\n}();\n\nexports.default = TChannelServer;\n\n\nif (require.main === module) {\n    var tchannel = new TChannelServer();\n}\n//# sourceMappingURL=tchannel_server.js.map"]}