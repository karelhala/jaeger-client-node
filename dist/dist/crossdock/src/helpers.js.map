{"version":3,"sources":["../../../crossdock/src/helpers.js"],"names":["Object","defineProperty","exports","value","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","key","Constructor","protoProps","staticProps","prototype","_constants","require","constants","_interopRequireWildcard","_fs","_fs2","_interopRequireDefault","_path","_path2","_dns","_dns2","_default_context","_default_context2","_opentracing","_opentracing2","_request","_request2","_rsvp","_rsvp2","_span","_span2","_span_context","_span_context2","_tracer","_tracer2","_channel","_channel2","_thrift","_thrift2","_tchannel_bridge","_tchannel_bridge2","_util","_util2","obj","__esModule","default","newObj","hasOwnProperty","call","_classCallCheck","instance","TypeError","Helpers","tracer","channel","makeSubChannel","serviceName","peers","myIp","crossdockSpec","readFileSync","join","__dirname","thriftChannel","source","bridge","_tracedChannel","tracedChannel","handleRequest","isStartRequest","traceRequest","serverSpan","setBaggageItem","BAGGAGE_KEY","baggage","sampled","setTag","Tags","SAMPLING_PRIORITY","prepareResponse","serverRole","downstream","_this","Promise","resolve","reject","observedSpan","observeSpan","response","span","notImplementedError","log","json2str","callDownstream","then","downstreamResponse","transport","TRANSPORT_HTTP","callDownstreamHTTP","TRANSPORT_TCHANNEL","callDownstreamTChannel","TRANSPORT_DUMMY","_this2","port","parseInt","downstreamUrl","host","clientSpan","startSpan","childOf","context","headers","inject","FORMAT_HTTP_HEADERS","post","JSON","stringify","err","finish","parse","body","_this3","setSpan","request","timeout","cn","trace","retryFlags","never","joinTraceRequest","send","observed","traceId","traceIdStr","isSampled","getBaggageItem","process","env","NODE_ENV","_len","arguments","args","Array","_key","console","apply","json"],"mappings":"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","file":"helpers.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nvar _constants = require('./constants.js');\n\nvar constants = _interopRequireWildcard(_constants);\n\nvar _fs = require('fs');\n\nvar _fs2 = _interopRequireDefault(_fs);\n\nvar _path = require('path');\n\nvar _path2 = _interopRequireDefault(_path);\n\nvar _dns = require('dns');\n\nvar _dns2 = _interopRequireDefault(_dns);\n\nvar _default_context = require('../../src/default_context');\n\nvar _default_context2 = _interopRequireDefault(_default_context);\n\nvar _opentracing = require('opentracing');\n\nvar _opentracing2 = _interopRequireDefault(_opentracing);\n\nvar _request = require('request');\n\nvar _request2 = _interopRequireDefault(_request);\n\nvar _rsvp = require('rsvp');\n\nvar _rsvp2 = _interopRequireDefault(_rsvp);\n\nvar _span = require('../../src/span.js');\n\nvar _span2 = _interopRequireDefault(_span);\n\nvar _span_context = require('../../src/span_context.js');\n\nvar _span_context2 = _interopRequireDefault(_span_context);\n\nvar _tracer = require('../../src/tracer.js');\n\nvar _tracer2 = _interopRequireDefault(_tracer);\n\nvar _channel = require('tchannel/channel');\n\nvar _channel2 = _interopRequireDefault(_channel);\n\nvar _thrift = require('tchannel/as/thrift');\n\nvar _thrift2 = _interopRequireDefault(_thrift);\n\nvar _tchannel_bridge = require('../../src/tchannel_bridge');\n\nvar _tchannel_bridge2 = _interopRequireDefault(_tchannel_bridge);\n\nvar _util = require('../../src/util.js');\n\nvar _util2 = _interopRequireDefault(_util);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar Helpers = function () {\n    function Helpers(tracer) {\n        _classCallCheck(this, Helpers);\n\n        this._tracer = tracer;\n\n        var channel = (0, _channel2.default)().makeSubChannel({\n            serviceName: 'node',\n            peers: [_util2.default.myIp() + ':8082']\n        });\n\n        var crossdockSpec = _fs2.default.readFileSync(_path2.default.join(__dirname, '..', '..', 'src', 'jaeger-idl', 'thrift', 'crossdock', 'tracetest.thrift'), 'utf8');\n        var thriftChannel = (0, _thrift2.default)({\n            channel: channel,\n            source: crossdockSpec\n        });\n\n        var bridge = new _tchannel_bridge2.default(this._tracer);\n        this._tracedChannel = bridge.tracedChannel(thriftChannel);\n    }\n\n    _createClass(Helpers, [{\n        key: 'handleRequest',\n        value: function handleRequest(isStartRequest, traceRequest, serverSpan) {\n            if (isStartRequest) {\n                serverSpan.setBaggageItem(constants.BAGGAGE_KEY, traceRequest.baggage);\n                if (traceRequest.sampled) {\n                    serverSpan.setTag(_opentracing2.default.Tags.SAMPLING_PRIORITY, 1);\n                }\n            }\n\n            // do async call to prepareResponse\n            return this.prepareResponse(traceRequest.serverRole, traceRequest.downstream, serverSpan);\n        }\n    }, {\n        key: 'prepareResponse',\n        value: function prepareResponse(serverRole, downstream, serverSpan) {\n            var _this = this;\n\n            return new _rsvp2.default.Promise(function (resolve, reject) {\n                var observedSpan = _this.observeSpan(serverSpan);\n                var response = {\n                    span: observedSpan,\n                    notImplementedError: ''\n                };\n                Helpers.log(serverRole, 'observed span', Helpers.json2str(observedSpan));\n\n                if (downstream) {\n                    _this.callDownstream(serverRole, downstream, serverSpan).then(function (downstreamResponse) {\n                        response.downstream = downstreamResponse;\n                        Helpers.log(serverRole, 'returning response', Helpers.json2str(response));\n                        resolve(response);\n                    });\n                } else {\n                    Helpers.log(serverRole, 'returning response', Helpers.json2str(response));\n                    resolve(response);\n                }\n            });\n        }\n    }, {\n        key: 'callDownstream',\n        value: function callDownstream(serverRole, downstream, serverSpan) {\n            Helpers.log(serverRole, 'calling downstream', Helpers.json2str(downstream));\n            var transport = downstream.transport;\n            if (transport === constants.TRANSPORT_HTTP) {\n                return this.callDownstreamHTTP(downstream, serverSpan);\n            } else if (transport === constants.TRANSPORT_TCHANNEL) {\n                return this.callDownstreamTChannel(downstream, serverSpan);\n            } else if (transport == constants.TRANSPORT_DUMMY) {\n                return new _rsvp2.default.Promise(function (resolve, reject) {\n                    resolve({ 'notImplementedError': 'Dummy has not been implemented' });\n                });\n            } else {\n                return new _rsvp2.default.Promise(function (resolve, reject) {\n                    resolve({ 'notImplementedError': 'Unrecognized transport received: ' + transport });\n                });\n            }\n        }\n    }, {\n        key: 'callDownstreamHTTP',\n        value: function callDownstreamHTTP(downstream, serverSpan) {\n            var _this2 = this;\n\n            return new _rsvp2.default.Promise(function (resolve, reject) {\n\n                var port = parseInt(downstream.port);\n                var downstreamUrl = 'http://' + downstream.host + ':' + port + '/join_trace';\n\n                var clientSpan = _this2._tracer.startSpan('client-span', { childOf: serverSpan.context() });\n                var headers = { 'Content-Type': 'application/json' };\n                _this2._tracer.inject(clientSpan.context(), _opentracing2.default.FORMAT_HTTP_HEADERS, headers);\n\n                _request2.default.post({\n                    'url': downstreamUrl,\n                    'forever': true,\n                    'headers': headers,\n                    'body': JSON.stringify({\n                        'serverRole': downstream.serverRole,\n                        'downstream': downstream.downstream\n                    })\n                }, function (err, response) {\n                    if (err) {\n                        Helpers.log('error in downstream call:', err);\n                        clientSpan.finish();\n                        reject(err);\n                        return;\n                    }\n\n                    clientSpan.finish();\n                    var downstreamResponse = JSON.parse(response.body);\n                    resolve(downstreamResponse);\n                });\n            });\n        }\n    }, {\n        key: 'callDownstreamTChannel',\n        value: function callDownstreamTChannel(downstream, serverSpan) {\n            var _this3 = this;\n\n            return new _rsvp2.default.Promise(function (resolve, reject) {\n                var port = parseInt(downstream.port);\n                var downstreamUrl = 'http://' + downstream.host + ':' + port + '/join_trace';\n\n                var context = new _default_context2.default();\n                context.setSpan(serverSpan);\n                var request = _this3._tracedChannel.request({\n                    timeout: 5000,\n                    context: context,\n                    headers: {\n                        cn: 'tcollector-requestor'\n                    },\n                    trace: true,\n                    serviceName: 'node',\n                    retryFlags: { never: true }\n                });\n                var joinTraceRequest = {\n                    'serverRole': downstream.serverRole\n                };\n\n                if (downstream.downstream) {\n                    joinTraceRequest.downstream = downstream.downstream;\n                }\n\n                request.send('TracedService::joinTrace', null, { request: joinTraceRequest }, function (err, response) {\n                    if (err) {\n                        Helpers.log('tchannel err', err);\n                        return;\n                    }\n                    resolve(response.body);\n                });\n            });\n        }\n    }, {\n        key: 'observeSpan',\n        value: function observeSpan(span) {\n            var observed = {\n                traceId: 'no span found',\n                sampled: false,\n                baggage: 'no span found'\n            };\n\n            if (span) {\n                observed = {\n                    traceId: span.context().traceIdStr || '',\n                    sampled: span.context().isSampled(),\n                    baggage: span.getBaggageItem(constants.BAGGAGE_KEY)\n                };\n            }\n            return observed;\n        }\n    }], [{\n        key: 'log',\n        value: function log() {\n            // $FlowIgnore - stop complaining about property `env` not found\n            if (process.env.NODE_ENV !== 'test') {\n                for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {\n                    args[_key] = arguments[_key];\n                }\n\n                console.log.apply(null, args);\n            }\n        }\n    }, {\n        key: 'json2str',\n        value: function json2str(json) {\n            return JSON.stringify(json);\n        }\n    }]);\n\n    return Helpers;\n}();\n\nexports.default = Helpers;\n//# sourceMappingURL=helpers.js.map"]}