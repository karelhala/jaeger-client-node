{"version":3,"sources":["../../../crossdock/src/http_server.js"],"names":["Object","defineProperty","exports","value","_bodyParser","require","_bodyParser2","_interopRequireDefault","_const_sampler","_const_sampler2","_express","_express2","_helpers","_helpers2","_in_memory_reporter","_in_memory_reporter2","_opentracing","_opentracing2","_tracer","_tracer2","_endtoend_handler","_endtoend_handler2","obj","__esModule","default","_classCallCheck","instance","Constructor","TypeError","HttpServer","_this","app","handler","use","json","endpoints","url","startRequest","forEach","endpoint","post","req","res","parentContext","extract","FORMAT_HTTP_HEADERS","headers","serverSpan","startSpan","childOf","traceRequest","body","log","serverRole","json2str","promise","handleRequest","then","response","finish","traceResponse","JSON","stringify","send","generateTraces","listen","main","module","http"],"mappings":"AAAA;;AAEAA,OAAOC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AACzCC,WAAO;AADkC,CAA7C;;AAIA,IAAIC,cAAcC,QAAQ,aAAR,CAAlB;;AAEA,IAAIC,eAAeC,uBAAuBH,WAAvB,CAAnB;;AAEA,IAAII,iBAAiBH,QAAQ,qCAAR,CAArB;;AAEA,IAAII,kBAAkBF,uBAAuBC,cAAvB,CAAtB;;AAEA,IAAIE,WAAWL,QAAQ,SAAR,CAAf;;AAEA,IAAIM,YAAYJ,uBAAuBG,QAAvB,CAAhB;;AAEA,IAAIE,WAAWP,QAAQ,WAAR,CAAf;;AAEA,IAAIQ,YAAYN,uBAAuBK,QAAvB,CAAhB;;AAEA,IAAIE,sBAAsBT,QAAQ,2CAAR,CAA1B;;AAEA,IAAIU,uBAAuBR,uBAAuBO,mBAAvB,CAA3B;;AAEA,IAAIE,eAAeX,QAAQ,aAAR,CAAnB;;AAEA,IAAIY,gBAAgBV,uBAAuBS,YAAvB,CAApB;;AAEA,IAAIE,UAAUb,QAAQ,qBAAR,CAAd;;AAEA,IAAIc,WAAWZ,uBAAuBW,OAAvB,CAAf;;AAEA,IAAIE,oBAAoBf,QAAQ,oBAAR,CAAxB;;AAEA,IAAIgB,qBAAqBd,uBAAuBa,iBAAvB,CAAzB;;AAEA,SAASb,sBAAT,CAAgCe,GAAhC,EAAqC;AAAE,WAAOA,OAAOA,IAAIC,UAAX,GAAwBD,GAAxB,GAA8B,EAAEE,SAASF,GAAX,EAArC;AAAwD;;AAE/F,SAASG,eAAT,CAAyBC,QAAzB,EAAmCC,WAAnC,EAAgD;AAAE,QAAI,EAAED,oBAAoBC,WAAtB,CAAJ,EAAwC;AAAE,cAAM,IAAIC,SAAJ,CAAc,mCAAd,CAAN;AAA2D;AAAE;AACzJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,IAAIC,aAAa,SAASA,UAAT,GAAsB;AACnC,QAAIC,QAAQ,IAAZ;;AAEAL,oBAAgB,IAAhB,EAAsBI,UAAtB;;AAEA,QAAIE,MAAM,CAAC,GAAGpB,UAAUa,OAAd,GAAV;AACA,SAAKN,OAAL,GAAe,IAAIC,SAASK,OAAb,CAAqB,MAArB,EAA6B,IAAIT,qBAAqBS,OAAzB,EAA7B,EAAiE,IAAIf,gBAAgBe,OAApB,CAA4B,KAA5B,CAAjE,CAAf;AACA,SAAKZ,QAAL,GAAgB,IAAIC,UAAUW,OAAd,CAAsB,KAAKN,OAA3B,CAAhB;AACA,QAAIc,UAAU,IAAIX,mBAAmBG,OAAvB,EAAd;;AAEA;AACAO,QAAIE,GAAJ,CAAQ3B,aAAakB,OAAb,CAAqBU,IAArB,EAAR;;AAEA,QAAIC,YAAY,CAAC,EAAEC,KAAK,cAAP,EAAuBC,cAAc,IAArC,EAAD,EAA8C,EAAED,KAAK,aAAP,EAAsBC,cAAc,KAApC,EAA9C,CAAhB;;AAEAF,cAAUG,OAAV,CAAkB,UAAUC,QAAV,EAAoB;AAClCR,YAAIS,IAAJ,CAASD,SAASH,GAAlB,EAAuB,UAAUK,GAAV,EAAeC,GAAf,EAAoB;AACvC,gBAAIC,gBAAgBb,MAAMZ,OAAN,CAAc0B,OAAd,CAAsB3B,cAAcO,OAAd,CAAsBqB,mBAA5C,EAAiEJ,IAAIK,OAArE,CAApB;AACA,gBAAIC,aAAajB,MAAMZ,OAAN,CAAc8B,SAAd,CAAwBT,SAASH,GAAjC,EAAsC,EAAEa,SAASN,aAAX,EAAtC,CAAjB;AACA,gBAAIO,eAAeT,IAAIU,IAAvB;;AAEAtC,sBAAUW,OAAV,CAAkB4B,GAAlB,CAAsB,MAAtB,EAA8BF,aAAaG,UAA3C,EAAuD,kBAAvD,EAA2ExC,UAAUW,OAAV,CAAkB8B,QAAlB,CAA2BJ,YAA3B,CAA3E;;AAEA,gBAAIK,UAAUzB,MAAMlB,QAAN,CAAe4C,aAAf,CAA6BjB,SAASF,YAAtC,EAAoDa,YAApD,EAAkEH,UAAlE,CAAd;AACAQ,oBAAQE,IAAR,CAAa,UAAUC,QAAV,EAAoB;AAC7BX,2BAAWY,MAAX;AACA,oBAAIC,gBAAgBC,KAAKC,SAAL,CAAeJ,QAAf,CAApB;AACAhB,oBAAIqB,IAAJ,CAASH,aAAT;AACH,aAJD;AAKH,SAbD;AAcH,KAfD;AAgBA7B,QAAIS,IAAJ,CAAS,gBAAT,EAA2B,UAAUC,GAAV,EAAeC,GAAf,EAAoB;AAC3CV,gBAAQgC,cAAR,CAAuBvB,GAAvB,EAA4BC,GAA5B;AACH,KAFD;AAGAX,QAAIkC,MAAJ,CAAW,IAAX,EAAiB,YAAY;AACzBpD,kBAAUW,OAAV,CAAkB4B,GAAlB,CAAsB,uCAAtB;AACH,KAFD;AAGH,CArCD;;AAuCAlD,QAAQsB,OAAR,GAAkBK,UAAlB;;AAGA,IAAIxB,QAAQ6D,IAAR,KAAiBC,MAArB,EAA6B;AACzB,QAAIC,OAAO,IAAIvC,UAAJ,EAAX;AACH;AACD","file":"http_server.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _bodyParser = require('body-parser');\n\nvar _bodyParser2 = _interopRequireDefault(_bodyParser);\n\nvar _const_sampler = require('../../src/samplers/const_sampler.js');\n\nvar _const_sampler2 = _interopRequireDefault(_const_sampler);\n\nvar _express = require('express');\n\nvar _express2 = _interopRequireDefault(_express);\n\nvar _helpers = require('./helpers');\n\nvar _helpers2 = _interopRequireDefault(_helpers);\n\nvar _in_memory_reporter = require('../../src/reporters/in_memory_reporter.js');\n\nvar _in_memory_reporter2 = _interopRequireDefault(_in_memory_reporter);\n\nvar _opentracing = require('opentracing');\n\nvar _opentracing2 = _interopRequireDefault(_opentracing);\n\nvar _tracer = require('../../src/tracer.js');\n\nvar _tracer2 = _interopRequireDefault(_tracer);\n\nvar _endtoend_handler = require('./endtoend_handler');\n\nvar _endtoend_handler2 = _interopRequireDefault(_endtoend_handler);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nvar HttpServer = function HttpServer() {\n    var _this = this;\n\n    _classCallCheck(this, HttpServer);\n\n    var app = (0, _express2.default)();\n    this._tracer = new _tracer2.default('node', new _in_memory_reporter2.default(), new _const_sampler2.default(false));\n    this._helpers = new _helpers2.default(this._tracer);\n    var handler = new _endtoend_handler2.default();\n\n    // json responses need bodyParser when working with express\n    app.use(_bodyParser2.default.json());\n\n    var endpoints = [{ url: '/start_trace', startRequest: true }, { url: '/join_trace', startRequest: false }];\n\n    endpoints.forEach(function (endpoint) {\n        app.post(endpoint.url, function (req, res) {\n            var parentContext = _this._tracer.extract(_opentracing2.default.FORMAT_HTTP_HEADERS, req.headers);\n            var serverSpan = _this._tracer.startSpan(endpoint.url, { childOf: parentContext });\n            var traceRequest = req.body;\n\n            _helpers2.default.log('HTTP', traceRequest.serverRole, 'received request', _helpers2.default.json2str(traceRequest));\n\n            var promise = _this._helpers.handleRequest(endpoint.startRequest, traceRequest, serverSpan);\n            promise.then(function (response) {\n                serverSpan.finish();\n                var traceResponse = JSON.stringify(response);\n                res.send(traceResponse);\n            });\n        });\n    });\n    app.post('/create_traces', function (req, res) {\n        handler.generateTraces(req, res);\n    });\n    app.listen(8081, function () {\n        _helpers2.default.log('HTTP server listening on port 8081...');\n    });\n};\n\nexports.default = HttpServer;\n\n\nif (require.main === module) {\n    var http = new HttpServer();\n}\n//# sourceMappingURL=http_server.js.map"]}